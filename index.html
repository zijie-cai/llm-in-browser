<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AI Music Playlist Generator_c</title>
    <!-- Minimal Styling -->
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }
        #chatContainer {
            display: flex;
            flex-direction: column;
            height: 80vh;
        }
        #messages {
            flex: 1;
            border: 1px solid #ccc;
            padding: 10px;
            overflow-y: auto;
            margin-bottom: 10px;
            background-color: #f9f9f9;
        }
        #inputContainer {
            display: flex;
        }
        #userInput {
            flex: 1;
            padding: 10px;
            font-size: 1em;
            resize: none;
        }
        #sendBtn {
            padding: 10px 20px;
            font-size: 1em;
            margin-left: 5px;
        }
        .message {
            margin: 5px 0;
            white-space: pre-wrap; /* Preserve whitespace and line breaks */
        }
        .user {
            text-align: right;
            color: blue;
        }
        .assistant {
            text-align: left;
            color: green;
        }
        #progress {
            width: 100%;
            height: 20px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>

    <h1>AI Music Playlist Generator</h1>

    <progress id="progress" hidden></progress>

    <div id="chatContainer" hidden>
        <div id="messages"></div>
        <div id="inputContainer">
            <textarea id="userInput" rows="2" placeholder="Describe the kind of playlist you want..."></textarea>
            <button id="sendBtn" disabled>Generate Playlist</button>
        </div>
    </div>

    <script type="module">
        import { LLM } from "./llm.js/llm.js"; // Ensure the path is correct

        let LLMEngine;
        const sendButton = document.getElementById('sendBtn');
        const progress = document.getElementById('progress');
        const chatContainer = document.getElementById('chatContainer');
        const messages = document.getElementById('messages');
        const userInput = document.getElementById('userInput');

        // Variable to accumulate assistant's response
        let assistantResponse = '';

        // Model Configuration
        const modelConfig = {
            name: "Qwen2.5-0.5B-Instruct",
            url: "https://huggingface.co/bartowski/Qwen2.5-0.5B-Instruct-GGUF/resolve/main/Qwen2.5-0.5B-Instruct-Q4_K_M.gguf",
            type: "GGUF_CPU",
            promptStart: "<|im_start|>user\nMake a playlist of 10 unique songs based on the following description: ",
            promptEnd: ". Provide only a numbered list with each entry in the format 'number. \"Song Title\" by Artist Name - Duration'. Ensure there are no duplicate songs and maintain consistent formatting.\n<|im_end|>\n<|im_start|>assistant\n"
        };

        // Load Model Function
        const loadModel = () => {
            progress.hidden = false;
            progress.value = 0;
            LLMEngine = new LLM(
                modelConfig.type,
                modelConfig.url,
                onLoaded,
                writeMessage,
                onRunComplete,
                updateProgress
            );

            LLMEngine.load_worker();
        };

        // Update Progress Bar
        const updateProgress = (value) => {
            progress.value = value;
        };

        const onLoaded = () => {
            progress.hidden = true;
            chatContainer.hidden = false;
            sendButton.disabled = false;
            addMessage("System", "Model loaded. Describe the kind of playlist you want!");
            userInput.focus();
        };

        // Send Message to Model
        const sendMessage = () => {
            const text = userInput.value.trim();
            if (text === "") return;

            addMessage("User", text);
            userInput.value = "";
            sendButton.disabled = true;

            // Reset assistant response
            assistantResponse = '';

            const prompt = `${modelConfig.promptStart}${text}${modelConfig.promptEnd}`;
            const params = {
                prompt: prompt,
                max_token_len: 300, // Increased token length
                temperature: 0.7,    // Increased temperature
                top_k: 50            // Adjusted top_k
            };

            LLMEngine.run(params);
        };

        // Display Messages with HTML Escaping and Line Breaks
        const addMessage = (sender, text) => {
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('message', sender.toLowerCase());

            // Escape HTML to prevent injection
            const escapedText = escapeHTML(text);

            // Replace newline characters with <br> for proper formatting
            msgDiv.innerHTML = `<strong>${sender}:</strong> ${escapedText.replace(/\n/g, '<br>')}`;
            messages.appendChild(msgDiv);
            messages.scrollTop = messages.scrollHeight;
        };

        // Function to escape HTML special characters
        const escapeHTML = (str) => {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        };

        // Function to remove duplicate songs
        const removeDuplicates = (songs) => {
            const seen = new Set();
            return songs.filter(song => {
                const identifier = song.title.toLowerCase() + song.artist.toLowerCase();
                if (seen.has(identifier)) {
                    return false;
                }
                seen.add(identifier);
                return true;
            });
        };

        // Function to parse and validate the assistant's response
        const parseAssistantResponse = (response) => {
            const lines = response.split('\n');
            const songs = [];

            const songRegex = /^(\d+)\.\s*"(.+)"\s+by\s+(.+?)\s+-\s+([\d:]+)$/;

            lines.forEach(line => {
                const match = line.match(songRegex);
                if (match) {
                    const [, number, title, artist, duration] = match;
                    songs.push({ number: parseInt(number), title, artist, duration });
                }
            });

            // Remove duplicates
            const uniqueSongs = removeDuplicates(songs);

            // Ensure exactly 10 songs
            if (uniqueSongs.length < 10) {
                alert('The generated playlist contains fewer than 10 unique songs. Please try again.');
            }

            return uniqueSongs;
        };

        // Receive Message from Model
        const writeMessage = (line) => {
            assistantResponse += line + '\n';
        };

        const onRunComplete = () => {
            // Remove the last newline character
            assistantResponse = assistantResponse.trim();

            // Parse and clean the response
            const cleanSongs = parseAssistantResponse(assistantResponse);

            // Format the clean list
            const formattedList = cleanSongs.map(song => `${song.number}. "${song.title}" by ${song.artist} - ${song.duration}`).join('\n');

            addMessage("Assistant", formattedList);
            sendButton.disabled = false;
        };

        // Event Listeners
        sendButton.addEventListener("click", sendMessage);
        userInput.addEventListener("keypress", (e) => {
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Automatically Load Model on Page Load
        window.addEventListener('DOMContentLoaded', (event) => {
            loadModel();
        });
    </script>

</body>
</html>
