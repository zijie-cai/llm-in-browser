<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AI Music Playlist Generator</title>
    <!-- Minimal Styling -->
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }
        #chatContainer {
            display: flex;
            flex-direction: column;
            height: 80vh;
        }
        #messages {
            flex: 1;
            border: 1px solid #ccc;
            padding: 10px;
            overflow-y: auto;
            margin-bottom: 10px;
            background-color: #f9f9f9;
        }
        #inputContainer {
            display: flex;
        }
        #userInput {
            flex: 1;
            padding: 10px;
            font-size: 1em;
            resize: none;
        }
        #sendBtn {
            padding: 10px 20px;
            font-size: 1em;
            margin-left: 5px;
        }
        .message {
            margin: 5px 0;
            white-space: pre-wrap; /* Preserve whitespace and line breaks */
        }
        .user {
            text-align: right;
            color: blue;
        }
        .assistant {
            text-align: left;
            color: green;
        }
        #progress {
            width: 100%;
            height: 20px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>

    <h1>AI Music Playlist Generator</h1>

    <progress id="progress" hidden></progress>

    <div id="chatContainer" hidden>
        <div id="messages"></div>
        <div id="inputContainer">
            <textarea id="userInput" rows="2" placeholder="Describe the kind of playlist you want..."></textarea>
            <button id="sendBtn" disabled>Generate Playlist</button>
        </div>
    </div>

    <script type="module">
        import { LLM } from "./llm.js/llm.js"; // Ensure the path is correct

        let LLMEngine;
        const sendButton = document.getElementById('sendBtn');
        const progress = document.getElementById('progress');
        const chatContainer = document.getElementById('chatContainer');
        const messages = document.getElementById('messages');
        const userInput = document.getElementById('userInput');

        // Variable to accumulate assistant's response
        let assistantResponse = '';

        // Model Configuration
        const modelConfig = {
            name: "Qwen2.5-0.5B-Instruct",
            url: "https://huggingface.co/bartowski/Qwen2.5-0.5B-Instruct-GGUF/resolve/main/Qwen2.5-0.5B-Instruct-Q4_K_M.gguf",
            type: "GGUF_CPU",
            prompt: "Make a playlist of 10 unique songs based on the following description. Provide only a numbered list with song titles and artist names, each on a new line, without any additional text or explanations. Ensure that there are no duplicate songs and that the numbering is correct from 1 to 10.",
        };

        // Load Model Function
        const loadModel = () => {
            progress.hidden = false;
            progress.value = 0;
            LLMEngine = new LLM(
                modelConfig.type,
                modelConfig.url,
                onLoaded,
                writeMessage,
                onRunComplete,
                updateProgress
            );

            LLMEngine.load_worker();
        };

        // Update Progress Bar
        const updateProgress = (value) => {
            progress.value = value;
        };

        const onLoaded = () => {
            progress.hidden = true;
            chatContainer.hidden = false;
            sendButton.disabled = false;
            addMessage("System", "Model loaded. Describe the kind of playlist you want!");
            userInput.focus();
        };

        // Send Message to Model
        const sendMessage = () => {
            const text = userInput.value.trim();
            if (text === "") return;

            addMessage("User", text);
            userInput.value = "";
            sendButton.disabled = true;

            // Reset assistant response
            assistantResponse = '';

            const prompt = `${modelConfig.prompt}\nDescription: ${text}`;
            const params = {
                prompt: prompt,
                max_token_len: 200,
                top_k: 1
            };

            LLMEngine.run(params);
        };

        // Display Messages with HTML Escaping and Line Breaks
        const addMessage = (sender, text) => {
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('message', sender.toLowerCase());

            // Escape HTML to prevent injection
            const escapedText = escapeHTML(text);

            // Replace newline characters with <br> for proper formatting
            msgDiv.innerHTML = `<strong>${sender}:</strong> ${escapedText.replace(/\n/g, '<br>')}`;
            messages.appendChild(msgDiv);
            messages.scrollTop = messages.scrollHeight;
        };

        // Function to escape HTML special characters
        const escapeHTML = (str) => {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        };

        // Receive Message from Model
        const writeMessage = (line) => {
            assistantResponse += line + '\n';
        };

        const onRunComplete = () => {
            // Remove the last newline character
            assistantResponse = assistantResponse.trim();

            // Post-processing to remove any unintended text
            const cleanedResponse = assistantResponse
                .split('\n')
                .filter(line => {
                    const lower = line.toLowerCase();
                    return !lower.startsWith('user') && !lower.startsWith('assistant');
                })
                .join('\n');

            // Further clean up duplicates and incorrect numbering if necessary
            const uniqueLines = [];
            const seen = new Set();
            const lines = cleanedResponse.split('\n');
            lines.forEach(line => {
                // Validate the line format: starts with a number followed by a period
                if (/^\d+\.\s/.test(line)) {
                    // Check for duplicates
                    if (!seen.has(line)) {
                        uniqueLines.push(line);
                        seen.add(line);
                    }
                }
            });

            // Check if we have exactly 10 songs
            if (uniqueLines.length === 10) {
                addMessage("Assistant", uniqueLines.join('<br>'));
            } else {
                addMessage("Assistant", "Sorry, I encountered an issue generating a proper playlist. Please try again.");
            }

            sendButton.disabled = false;
        };

        // Event Listeners
        sendButton.addEventListener("click", sendMessage);
        userInput.addEventListener("keypress", (e) => {
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Automatically Load Model on Page Load
        window.addEventListener('DOMContentLoaded', (event) => {
            loadModel();
        });
    </script>

</body>
</html>
