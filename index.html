<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Minimal LLM Chat Interface</title>
    <!-- Minimal Styling -->
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }
        #chatContainer {
            display: flex;
            flex-direction: column;
            height: 80vh;
        }
        #messages {
            flex: 1;
            border: 1px solid #ccc;
            padding: 10px;
            overflow-y: auto;
            margin-bottom: 10px;
            background-color: #f9f9f9;
        }
        #inputContainer {
            display: flex;
        }
        #userInput {
            flex: 1;
            padding: 10px;
            font-size: 1em;
        }
        #sendBtn, #loadBtn {
            padding: 10px 20px;
            font-size: 1em;
            margin-left: 5px;
        }
        .message {
            margin: 5px 0;
        }
        .user {
            text-align: right;
            color: blue;
        }
        .assistant {
            text-align: left;
            color: green;
        }
        #progress {
            width: 100%;
            height: 20px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>

    <h1>LLM Chat Interface</h1>

    <button id="loadBtn">Load Qwen2.5-0.5B-Instruct Model</button>
    <progress id="progress" hidden></progress>

    <div id="chatContainer" hidden>
        <div id="messages"></div>
        <div id="inputContainer">
            <textarea id="userInput" rows="2" placeholder="Type your message here..."></textarea>
            <button id="sendBtn" disabled>Send</button>
        </div>
    </div>

    <script type="module">
        import { LLM } from "./llm.js/llm.js"; // Ensure the path is correct

        let LLMEngine;
        const loadButton = document.getElementById('loadBtn');
        const sendButton = document.getElementById('sendBtn');
        const progress = document.getElementById('progress');
        const chatContainer = document.getElementById('chatContainer');
        const messages = document.getElementById('messages');
        const userInput = document.getElementById('userInput');

        // Model Configuration
        const modelConfig = {
            name: "Qwen2.5-0.5B-Instruct",
            url: "https://huggingface.co/bartowski/Qwen2.5-0.5B-Instruct-GGUF/resolve/main/Qwen2.5-0.5B-Instruct-Q4_K_M.gguf",
            type: "GGUF_CPU",
            prompt: "<|im_start|>user\n"
        };

        // Load Model Function
        const loadModel = () => {
            progress.hidden = false;
            loadButton.disabled = true;
            loadButton.textContent = "Loading...";

            LLMEngine = new LLM(
                modelConfig.type,
                modelConfig.url,
                onLoaded,
                writeMessage,
                onRunComplete
            );

            LLMEngine.load_worker();
        };

        const onLoaded = () => {
            progress.hidden = true;
            loadButton.hidden = true;
            chatContainer.hidden = false;
            sendButton.disabled = false;
            addMessage("System", "Model loaded. You can start chatting!");
        };

        // Send Message to Model
        const sendMessage = () => {
            const text = userInput.value.trim();
            if (text === "") return;

            addMessage("User", text);
            userInput.value = "";
            sendButton.disabled = true;

            const params = {
                prompt: modelConfig.prompt + text + "\n<|im_end|>\n<|im_start|>assistant\n",
                max_token_len: 100,
                top_k: 1
            };

            LLMEngine.run(params);
        };

        // Display Messages
        const addMessage = (sender, text) => {
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('message', sender.toLowerCase());
            msgDiv.textContent = `${sender}: ${text}`;
            messages.appendChild(msgDiv);
            messages.scrollTop = messages.scrollHeight;
        };

        // Receive Message from Model
        const writeMessage = (line) => {
            addMessage("Assistant", line);
        };

        const onRunComplete = () => {
            sendButton.disabled = false;
        };

        // Event Listeners
        loadButton.addEventListener("click", loadModel);
        sendButton.addEventListener("click", sendMessage);
        userInput.addEventListener("keypress", (e) => {
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

    </script>

</body>
</html>
