<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Qwen2.5 Chat Interface</title>
    <!-- Minimalistic CSS for styling -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/water.css@2/out/light.css"
    />
    <style>
        body {
            display: flex;
            flex-direction: column;
            height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        #chat-container {
            flex: 1;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .message {
            margin: 5px 0;
        }
        .user {
            text-align: right;
            color: blue;
        }
        .assistant {
            text-align: left;
            color: green;
        }
        #input-container {
            display: flex;
        }
        #textInput {
            flex: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            resize: none;
        }
        #submitBtn {
            padding: 10px 20px;
            margin-left: 10px;
            border: none;
            background-color: #007BFF;
            color: white;
            border-radius: 5px;
            cursor: pointer;
        }
        #submitBtn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        #progress {
            display: none;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>

    <h1>Qwen2.5 Chat</h1>

    <progress id="progress" max="100"></progress>

    <div id="chat-container">
        <!-- Chat messages will appear here -->
    </div>

    <div id="input-container">
        <textarea id="textInput" rows="2" placeholder="Type your message here..."></textarea>
        <button id="submitBtn" disabled>Send</button>
    </div>

    <script type="module">
        import { LLM } from "./llm.js/llm.js";

        let LLMEngine;

        const progress = document.getElementById('progress');
        const submitButton = document.getElementById('submitBtn');
        const textInput = document.getElementById('textInput');
        const chatContainer = document.getElementById('chat-container');

        // Initialize the model on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadModel();
        });

        // Function to load the Qwen2.5-0.5B-Instruct model
        const loadModel = () => {
            progress.style.display = 'block';
            progress.value = 0;

            const model = {
                model: "https://huggingface.co/bartowski/Qwen2.5-0.5B-Instruct-GGUF/resolve/main/Qwen2.5-0.5B-Instruct-Q4_K_M.gguf",
                type: "GGUF_CPU"
            };

            LLMEngine = new LLM(
                model.type,
                model.model,
                onLoaded,
                writeResult,
                onRunComplete
            );

            LLMEngine.load_worker();
        };

        // Callback when the model is loaded
        const onLoaded = () => {
            progress.style.display = 'none';
            submitButton.disabled = false;
        };

        // Function to display assistant's response
        const writeResult = (line) => {
            const message = document.createElement('div');
            message.classList.add('message', 'assistant');
            message.textContent += line;
            chatContainer.appendChild(message);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        };

        // Callback when the run is complete
        const onRunComplete = () => {
            submitButton.disabled = false;
        };

        // Event listener for the send button
        submitButton.addEventListener("click", runModel);

        // Function to handle sending user input to the model
        const runModel = () => {
            const text = textInput.value.trim();
            if (!text) return;

            // Display user's message
            const userMessage = document.createElement('div');
            userMessage.classList.add('message', 'user');
            userMessage.textContent = text;
            chatContainer.appendChild(userMessage);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            // Clear input and disable send button
            textInput.value = "";
            submitButton.disabled = true;

            // Prepare parameters
            let params = {
                prompt: `<|im_start|>user\n${text}<|im_end|>\n<|im_start|>assistant\n`,
                max_token_len: 100,
                top_k: 1
            };

            // Run the model
            LLMEngine.run(params);
        };

        // Optional: Enable send button when there's input
        textInput.addEventListener('input', () => {
            submitButton.disabled = textInput.value.trim() === "" || !LLMEngine;
        });
    </script>

</body>
</html>
